{"version":3,"sources":["detach/IosCodeSigning.js"],"names":["async","certPath","certPassword","teamID","certData","await","fs","readFile","fingerprint","_genP12CertFingerprint","identities","_findIdentitiesByTeamID","isValid","indexOf","Error","ensureCertificateValid","output","spawnAsyncThrowError","stdio","join","plistPath","data","toWrite","createExportOptionsPlist","writeFile","writeExportOptionsPlistFile","ipaPath","workspace","archivePath","codeSignIdentity","exportOptionsPlistPath","plistData","keychainPath","exportMethod","credentials","client","path","Dir","env","process","CI","runFastlane","basename","dirname","buildPhase","buildIPA","generatedEntitlementsPath","decodedProvisioningProfileEntitlements","Entitlements","entitlementsPattern","entitlementsPaths","glob","length","archiveEntitlementsPath","archiveEntitlementsRaw","archiveEntitlementsData","_","attempt","plist","parse","String","isError","message","entitlements","entitlementTransferRules","forEach","rule","generatedEntitlements","pickBy","val","key","includes","blacklistedEntitlementKeys","generatedEntitlementsPlistData","build","mode","plistDataReformatted","createEntitlementsFile","entitlementsPath","provisioningProfilePath","sourceIpaPath","destIpaPath","resignIPA","fastlaneArgs","loggerFields","fastlaneEnvVars","FASTLANE_SKIP_UPDATE_CHECK","FASTLANE_DISABLE_COLORS","FASTLANE_TEAM_ID","LC_ALL","pipeToLogger","dontShowStdout","p12Buffer","passwordRaw","_getCertData","certAsn1","forge","pki","certificateToAsn1","certDer","asn1","toDer","getBytes","md","sha1","create","update","digest","toHex","toUpperCase","findP12CertSerialNumber","serialNumber","replace","Buffer","isBuffer","toString","password","p12Der","util","decode64","p12Asn1","fromDer","p12","pkcs12","pkcs12FromAsn1","certBagType","oids","certBag","get","getBags","bagType","validateProvisioningProfile","params","_ensureDeveloperCertificateIsValid","distCertFingerprint","_ensureBundleIdentifierIsValid","devCertBase64","DeveloperCertificates","devCertFingerprint","_genDerCertFingerprint","certBase64","certBuffer","from","crypto","createHash","bundleIdentifier","expectedApplicationIdentifier","actualApplicationIdentifier","actualBundleIdentifier","exec","provisioningProfileUUID","resolveExportMethod","ProvisionedDevices","ProvisionsAllDevices"],"mappings":"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","file":"../../detach/IosCodeSigning.js","sourcesContent":["import forge from 'node-forge';\nimport _ from 'lodash';\nimport fs from 'fs-extra';\nimport path from 'path';\nimport glob from 'glob-promise';\nimport plist from 'plist';\nimport crypto from 'crypto';\n\nimport { spawnAsyncThrowError } from './ExponentTools';\n\nasync function ensureCertificateValid({ certPath, certPassword, teamID }) {\n  const certData = await fs.readFile(certPath);\n  const fingerprint = _genP12CertFingerprint(certData, certPassword);\n  const identities = await _findIdentitiesByTeamID(teamID);\n  const isValid = identities.indexOf(fingerprint) !== -1;\n  if (!isValid) {\n    throw new Error(`codesign ident not present in find-identity: ${fingerprint}\\n${identities}`);\n  }\n  return fingerprint;\n}\n\nfunction _genP12CertFingerprint(p12Buffer, passwordRaw) {\n  const certData = _getCertData(p12Buffer, passwordRaw);\n  const certAsn1 = forge.pki.certificateToAsn1(certData);\n  const certDer = forge.asn1.toDer(certAsn1).getBytes();\n  return forge.md.sha1\n    .create()\n    .update(certDer)\n    .digest()\n    .toHex()\n    .toUpperCase();\n}\n\nfunction findP12CertSerialNumber(p12Buffer, passwordRaw) {\n  const certData = _getCertData(p12Buffer, passwordRaw);\n  const { serialNumber } = certData;\n  return serialNumber ? certData.serialNumber.replace(/^0+/, '').toUpperCase() : null;\n}\n\nfunction _getCertData(p12Buffer, passwordRaw) {\n  if (Buffer.isBuffer(p12Buffer)) {\n    p12Buffer = p12Buffer.toString('base64');\n  } else if (typeof p12Buffer !== 'string') {\n    throw new Error('_getCertData only takes strings and buffers.');\n  }\n\n  const password = String(passwordRaw || '');\n  const p12Der = forge.util.decode64(p12Buffer);\n  const p12Asn1 = forge.asn1.fromDer(p12Der);\n  const p12 = forge.pkcs12.pkcs12FromAsn1(p12Asn1, password);\n  const certBagType = forge.pki.oids.certBag;\n  const certData = _.get(p12.getBags({ bagType: certBagType }), [certBagType, 0, 'cert']);\n  if (!certData) {\n    throw new Error(\"_getCertData: couldn't find cert bag\");\n  }\n  return certData;\n}\n\nasync function _findIdentitiesByTeamID(teamID) {\n  const { output } = await spawnAsyncThrowError(\n    'security',\n    ['find-identity', '-v', '-s', `(${teamID})`],\n    {\n      stdio: 'pipe',\n    }\n  );\n  return output.join('');\n}\n\nfunction validateProvisioningProfile(plistData, params) {\n  _ensureDeveloperCertificateIsValid(plistData, params.distCertFingerprint);\n  _ensureBundleIdentifierIsValid(plistData, params);\n}\n\nfunction _ensureDeveloperCertificateIsValid(plistData, distCertFingerprint) {\n  const devCertBase64 = plistData.DeveloperCertificates[0];\n  const devCertFingerprint = _genDerCertFingerprint(devCertBase64);\n  if (devCertFingerprint !== distCertFingerprint) {\n    throw new Error(\n      'validateProvisioningProfile: provisioning profile is not associated with uploaded distribution certificate'\n    );\n  }\n}\n\nfunction _genDerCertFingerprint(certBase64) {\n  const certBuffer = Buffer.from(certBase64, 'base64');\n  return crypto\n    .createHash('sha1')\n    .update(certBuffer)\n    .digest('hex')\n    .toUpperCase();\n}\n\nfunction _ensureBundleIdentifierIsValid(plistData, { bundleIdentifier, teamID }) {\n  const expectedApplicationIdentifier = `${teamID}.${bundleIdentifier}`;\n  const actualApplicationIdentifier = plistData.Entitlements['application-identifier'];\n\n  if (expectedApplicationIdentifier !== actualApplicationIdentifier) {\n    const actualBundleIdentifier = /\\.(.+)/.exec(actualApplicationIdentifier)[1];\n    throw new Error(\n      `validateProvisioningProfile: wrong bundleIdentifier found in provisioning profile; expected: ${bundleIdentifier}, found: ${actualBundleIdentifier}`\n    );\n  }\n}\n\nasync function writeExportOptionsPlistFile(plistPath, data) {\n  const toWrite = createExportOptionsPlist(data);\n  await fs.writeFile(plistPath, toWrite);\n}\n\nconst createExportOptionsPlist = ({\n  bundleIdentifier,\n  provisioningProfileUUID,\n  exportMethod,\n  teamID,\n}) => `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n<plist version=\"1.0\">\n  <dict>\n    <key>method</key>\n    <string>${exportMethod}</string>\n    <key>teamID</key>\n    <string>${teamID}</string>\n    <key>provisioningProfiles</key>\n    <dict>\n      <key>${bundleIdentifier}</key>\n      <string>${provisioningProfileUUID}</string>\n    </dict>\n  </dict>\n</plist>`;\n\nasync function buildIPA(\n  {\n    ipaPath,\n    workspace,\n    archivePath,\n    codeSignIdentity,\n    exportOptionsPlistPath,\n    plistData,\n    keychainPath,\n    exportMethod,\n  },\n  credentials,\n  client = false\n) {\n  if (client) {\n    await spawnAsyncThrowError(\n      'xcodebuild',\n      [\n        '-exportArchive',\n        '-archivePath',\n        archivePath,\n        '-exportOptionsPlist',\n        exportOptionsPlistPath,\n        '-exportPath',\n        path.Dir(ipaPath),\n        `OTHER_CODE_SIGN_FLAGS=\"--keychain ${keychainPath}\"`,\n      ],\n      {\n        env: { ...process.env, CI: 1 },\n      }\n    );\n  } else {\n    await runFastlane(\n      credentials,\n      [\n        'gym',\n        '-n',\n        path.basename(ipaPath),\n        '--workspace',\n        workspace,\n        '--scheme',\n        'ExpoKitApp',\n        '--archive_path',\n        archivePath,\n        '--skip_build_archive',\n        'true',\n        '-i',\n        codeSignIdentity,\n        '--export_options',\n        exportOptionsPlistPath,\n        '--export_method',\n        exportMethod,\n        '--export_xcargs',\n        `OTHER_CODE_SIGN_FLAGS=\"--keychain ${keychainPath}\"`,\n        '-o',\n        path.dirname(ipaPath),\n        '--verbose',\n      ],\n      { buildPhase: 'building and signing IPA' }\n    );\n  }\n}\n\nconst resolveExportMethod = plistData => {\n  if (plistData.ProvisionedDevices) {\n    return 'ad-hoc';\n  } else if (plistData.ProvisionsAllDevices === true) {\n    return 'enterprise';\n  } else {\n    return 'app-store';\n  }\n};\n\nconst entitlementTransferRules = [\n  'com.apple.developer.associated-domains',\n  'com.apple.developer.healthkit',\n  'com.apple.developer.homekit',\n  'com.apple.developer.icloud-container-identifiers',\n  'com.apple.developer.icloud-services',\n  'com.apple.developer.in-app-payments',\n  'com.apple.developer.networking.vpn.api',\n  'com.apple.developer.ubiquity-container-identifiers',\n  'com.apple.developer.ubiquity-kvstore-identifier',\n  'com.apple.external-accessory.wireless-configuration',\n  'com.apple.security.application-groups',\n  'inter-app-audio',\n  'keychain-access-groups',\n];\n\nconst blacklistedEntitlementKeys = [\n  'com.apple.developer.icloud-container-development-container-identifiers',\n  'com.apple.developer.icloud-container-environment',\n  'com.apple.developer.icloud-container-identifiers',\n  'com.apple.developer.icloud-services',\n  'com.apple.developer.restricted-resource-mode',\n  'com.apple.developer.ubiquity-container-identifiers',\n  'com.apple.developer.ubiquity-kvstore-identifier',\n  'inter-app-audio',\n  'com.apple.developer.homekit',\n  'com.apple.developer.healthkit',\n  'com.apple.developer.in-app-payments',\n  'com.apple.developer.maps',\n  'com.apple.external-accessory.wireless-configuration',\n];\n\nasync function createEntitlementsFile({ generatedEntitlementsPath, plistData, archivePath }) {\n  const decodedProvisioningProfileEntitlements = plistData.Entitlements;\n\n  const entitlementsPattern = path.join(\n    archivePath,\n    'Products/Applications/ExpoKitApp.app/*.entitlements'\n  );\n  const entitlementsPaths = await glob(entitlementsPattern);\n  if (entitlementsPaths.length === 0) {\n    throw new Error(\"Didn't find any generated entitlements file in archive.\");\n  } else if (entitlementsPaths.length !== 1) {\n    throw new Error('Found more than one entitlements file.');\n  }\n  const archiveEntitlementsPath = entitlementsPaths[0];\n  const archiveEntitlementsRaw = await fs.readFile(archiveEntitlementsPath);\n  const archiveEntitlementsData = _.attempt(plist.parse, String(archiveEntitlementsRaw));\n  if (_.isError(archiveEntitlementsData)) {\n    throw new Error(`Error when parsing plist: ${archiveEntitlementsData.message}`);\n  }\n\n  const entitlements = { ...decodedProvisioningProfileEntitlements };\n  entitlementTransferRules.forEach(rule => {\n    if (rule in archiveEntitlementsData) {\n      entitlements[rule] = archiveEntitlementsData[rule];\n    }\n  });\n  const generatedEntitlements = _.pickBy(\n    entitlements,\n    (val, key) => !_.includes(blacklistedEntitlementKeys, key)\n  );\n  const generatedEntitlementsPlistData = _.attempt(plist.build, generatedEntitlements);\n  await fs.writeFile(generatedEntitlementsPath, generatedEntitlementsPlistData, {\n    mode: 0o755,\n  });\n  const { output } = await spawnAsyncThrowError(\n    '/usr/libexec/PlistBuddy',\n    ['-x', '-c', 'Print', generatedEntitlementsPath],\n    {\n      stdio: 'pipe',\n    }\n  );\n  const plistDataReformatted = output.join('');\n  await fs.writeFile(generatedEntitlementsPath, plistDataReformatted, {\n    mode: 0o755,\n  });\n}\n\nasync function resignIPA(\n  {\n    codeSignIdentity,\n    entitlementsPath,\n    provisioningProfilePath,\n    sourceIpaPath,\n    destIpaPath,\n    keychainPath,\n  },\n  credentials\n) {\n  await spawnAsyncThrowError('cp', ['-rf', sourceIpaPath, destIpaPath]);\n  await runFastlane(\n    credentials,\n    [\n      'sigh',\n      'resign',\n      '--verbose',\n      '--entitlements',\n      entitlementsPath,\n      '--signing_identity',\n      codeSignIdentity,\n      '--keychain_path',\n      keychainPath,\n      '--provisioning_profile',\n      provisioningProfilePath,\n      destIpaPath,\n    ],\n    { buildPhase: 'building and signing IPA' }\n  );\n}\n\nasync function runFastlane({ teamID }, fastlaneArgs, loggerFields) {\n  const fastlaneEnvVars = {\n    FASTLANE_SKIP_UPDATE_CHECK: 1,\n    FASTLANE_DISABLE_COLORS: 1,\n    FASTLANE_TEAM_ID: teamID,\n    CI: 1,\n    LC_ALL: 'en_US.UTF-8',\n  };\n\n  await spawnAsyncThrowError('fastlane', fastlaneArgs, {\n    env: { ...process.env, ...fastlaneEnvVars },\n    pipeToLogger: true,\n    dontShowStdout: false,\n    loggerFields,\n  });\n}\n\nexport {\n  ensureCertificateValid,\n  findP12CertSerialNumber,\n  validateProvisioningProfile,\n  writeExportOptionsPlistFile,\n  buildIPA,\n  resolveExportMethod,\n  createEntitlementsFile,\n  resignIPA,\n};\n"],"sourceRoot":"/xdl@50.4.2/src"}