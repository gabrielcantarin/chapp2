{"version":3,"sources":["detach/IosShellApp.js"],"names":["async","projectName","workspacePath","configuration","type","relativeBuildDestination","verbose","let","buildCmd","pathToArtifact","buildDest","path","join","Error","logger","info","await","spawnAsyncThrowError","stdio","cwd","shell","resolve","_buildAsync","isRepoUpdateEnabled","pathsToClean","forEach","fs","existsSync","rimraf","sync","cocoapodsArgs","push","_podInstallAsync","args","expoSourcePath","workspaceSourcePath","privateConfigFile","privateConfigData","privateConfig","privateConfigContents","readFile","JSON","parse","manifest","url","sdkVersion","releaseChannel","getManifestAsync","buildFlags","StandaloneBuildFlags","createIos","appleTeamId","context","StandaloneContext","createServiceContext","archivePath","testEnvironment","_createStandaloneContextAsync","_validateCLIArgs","output","IosNSBundle","configureAsync","archiveName","config","slug","replace","appReleasePath","data","spawnAsync","DEFAULT_EXPOKIT_WORKSPACE_NAME","stdoutOnly","pipeToLogger","loggerFields","buildPhase","configureAndCopyArchiveAsync","skipRepoUpdate","build","ios","_","IosWorkspace","createDetachedAsync","_createTurtleWorkspaceAsync","createTurtleWorkspaceAsync","reuseWorkspace","getPaths","relative","artifactDestPath","buildAndCopyArtifactAsync","action"],"mappings":"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","file":"../../detach/IosShellApp.js","sourcesContent":["// Copyright 2015-present 650 Industries. All rights reserved.\n\n'use strict';\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport rimraf from 'rimraf';\n\nimport { getManifestAsync, spawnAsync, spawnAsyncThrowError } from './ExponentTools';\nimport * as IosNSBundle from './IosNSBundle';\nimport * as IosWorkspace from './IosWorkspace';\nimport StandaloneBuildFlags from './StandaloneBuildFlags';\nimport StandaloneContext from './StandaloneContext';\nimport logger from './Logger';\n\n// TODO: we will need to vary this when we support multiple different build artifacts.\nexport const DEFAULT_EXPOKIT_WORKSPACE_NAME = 'ExpoKitApp';\n\nfunction _validateCLIArgs(args) {\n  args.type = args.type || 'archive';\n  args.configuration = args.configuration || 'Release';\n  args.verbose = args.verbose || false;\n  args.testEnvironment = args.testEnvironment || 'none';\n\n  switch (args.type) {\n    case 'simulator': {\n      if (args.configuration !== 'Debug' && args.configuration !== 'Release') {\n        throw new Error(`Unsupported build configuration ${args.configuration}`);\n      }\n      break;\n    }\n    case 'archive': {\n      if (args.configuration !== 'Release') {\n        throw new Error('Release is the only supported configuration when archiving');\n      }\n      break;\n    }\n    default: {\n      throw new Error(`Unsupported build type ${args.type}`);\n    }\n  }\n\n  switch (args.action) {\n    case 'configure': {\n      if (!args.url) {\n        throw new Error('Must run with `--url MANIFEST_URL`');\n      }\n      if (!args.sdkVersion) {\n        throw new Error('Must run with `--sdkVersion SDK_VERSION`');\n      }\n      if (!args.archivePath) {\n        throw new Error(\n          'Need to provide --archivePath <path to existing archive for configuration>'\n        );\n      }\n      if (\n        args.testEnvironment !== 'local' &&\n        args.testEnvironment !== 'ci' &&\n        args.testEnvironment !== 'none'\n      ) {\n        throw new Error(`Unsupported test environment ${args.testEnvironment}`);\n      }\n      break;\n    }\n    case 'build': {\n      break;\n    }\n    case 'create-workspace': {\n      break;\n    }\n    default: {\n      throw new Error(`Unsupported build action ${args.action}`);\n    }\n  }\n\n  return args;\n}\n\n/**\n *  Build the iOS workspace at the given path.\n *  @return the path to the resulting build artifact\n */\nasync function _buildAsync(\n  projectName,\n  workspacePath,\n  configuration,\n  type,\n  relativeBuildDestination,\n  verbose\n) {\n  let buildCmd, pathToArtifact;\n  const buildDest = `${relativeBuildDestination}-${type}`;\n  if (type === 'simulator') {\n    buildCmd = `xcodebuild -workspace ${projectName}.xcworkspace -scheme ${projectName} -sdk iphonesimulator -configuration ${configuration} -derivedDataPath ${buildDest} CODE_SIGN_IDENTITY=\"\" CODE_SIGNING_REQUIRED=NO ARCHS=\"i386 x86_64\" ONLY_ACTIVE_ARCH=NO | xcpretty`;\n    pathToArtifact = path.join(\n      buildDest,\n      'Build',\n      'Products',\n      `${configuration}-iphonesimulator`,\n      `${projectName}.app`\n    );\n  } else if (type === 'archive') {\n    buildCmd = `xcodebuild -workspace ${projectName}.xcworkspace -scheme ${projectName} -sdk iphoneos -destination generic/platform=iOS -configuration ${configuration} archive -derivedDataPath ${buildDest} -archivePath ${buildDest}/${projectName}.xcarchive CODE_SIGN_IDENTITY=\"\" CODE_SIGNING_REQUIRED=NO | xcpretty`;\n    pathToArtifact = path.join(buildDest, `${projectName}.xcarchive`);\n  } else {\n    throw new Error(`Unsupported build type: ${type}`);\n  }\n\n  logger.info(`Building iOS workspace at ${workspacePath} to ${buildDest}:\\n`);\n  logger.info(buildCmd);\n  if (!verbose) {\n    logger.info(\n      '\\nxcodebuild is running. Logging errors only. To see full output, use --verbose 1...'\n    );\n  }\n  await spawnAsyncThrowError(buildCmd, null, {\n    // only stderr\n    stdio: verbose ? 'inherit' : ['ignore', 'ignore', 'inherit'],\n    cwd: workspacePath,\n    shell: true,\n  });\n  return path.resolve(workspacePath, pathToArtifact);\n}\n\nasync function _podInstallAsync(workspacePath, isRepoUpdateEnabled) {\n  // ensure pods are clean\n  const pathsToClean = [path.join(workspacePath, 'Pods'), path.join(workspacePath, 'Podfile.lock')];\n  pathsToClean.forEach(path => {\n    if (fs.existsSync(path)) {\n      rimraf.sync(path);\n    }\n  });\n\n  // install\n  let cocoapodsArgs = ['install'];\n  if (isRepoUpdateEnabled) {\n    cocoapodsArgs.push('--repo-update');\n  }\n  logger.info('Installing iOS workspace dependencies...');\n  logger.info(`pod ${cocoapodsArgs.join(' ')}`);\n  await spawnAsyncThrowError('pod', cocoapodsArgs, {\n    stdio: 'inherit',\n    cwd: workspacePath,\n  });\n}\n\n/**\n * @param workspacePath optionally provide a path for the unbuilt xcode workspace to create/use.\n * @param expoSourcePath path to expo client app sourcecode (/ios dir from expo/expo repo)\n */\nasync function _createStandaloneContextAsync(args) {\n  // right now we only ever build a single detached workspace for service contexts.\n  // TODO: support multiple different pod configurations, assemble a cache of those builds.\n  const expoSourcePath = args.expoSourcePath || '../ios';\n  let workspaceSourcePath;\n  if (args.workspacePath) {\n    workspaceSourcePath = args.workspacePath;\n  } else {\n    workspaceSourcePath = path.join(expoSourcePath, '..', 'shellAppWorkspaces', 'ios', 'default');\n  }\n  let { privateConfigFile, privateConfigData } = args;\n\n  let privateConfig;\n  if (privateConfigData) {\n    privateConfig = privateConfigData;\n  } else if (privateConfigFile) {\n    let privateConfigContents = await fs.readFile(privateConfigFile, 'utf8');\n    privateConfig = JSON.parse(privateConfigContents);\n  }\n\n  let manifest;\n  if (args.url && args.sdkVersion) {\n    const { url, sdkVersion, releaseChannel } = args;\n    manifest = await getManifestAsync(url, {\n      'Exponent-SDK-Version': sdkVersion,\n      'Exponent-Platform': 'ios',\n      'Expo-Release-Channel': releaseChannel ? releaseChannel : 'default',\n    });\n  }\n\n  const buildFlags = StandaloneBuildFlags.createIos(args.configuration, {\n    workspaceSourcePath,\n    appleTeamId: args.appleTeamId,\n  });\n  const context = StandaloneContext.createServiceContext(\n    expoSourcePath,\n    args.archivePath,\n    manifest,\n    privateConfig,\n    args.testEnvironment,\n    buildFlags,\n    args.url,\n    args.releaseChannel\n  );\n  return context;\n}\n\n/**\n * possible args:\n *  @param url manifest url for shell experience\n *  @param sdkVersion sdk to use when requesting the manifest\n *  @param releaseChannel channel to pull manifests from, default is 'default'\n *  @param archivePath path to existing NSBundle to configure\n *  @param privateConfigFile path to a private config file containing, e.g., private api keys\n *  @param appleTeamId Apple Developer's account Team ID\n *  @param output specify the output path of the configured archive (ie) /tmp/my-app-archive-build.xcarchive or /tmp/my-app-ios-build.tar.gz\n *  @param type type of artifact to configure (simulator or archive)\n *  @param expoSourcePath path to expo client app sourcecode (/ios dir from expo/expo repo)\n */\nasync function configureAndCopyArchiveAsync(args) {\n  args = _validateCLIArgs(args);\n  const { output, type } = args;\n  const context = await _createStandaloneContextAsync(args);\n  await IosNSBundle.configureAsync(context);\n  if (output) {\n    const archiveName = context.config.slug.replace(/[^0-9a-z_\\-]/gi, '_');\n    const appReleasePath = path.resolve(context.data.archivePath, '..');\n    if (type === 'simulator') {\n      await spawnAsync(\n        `mv ${DEFAULT_EXPOKIT_WORKSPACE_NAME}.app ${archiveName}.app && tar -czvf ${output} ${archiveName}.app`,\n        null,\n        {\n          stdoutOnly: true,\n          pipeToLogger: true,\n          loggerFields: { buildPhase: 'creating an archive for simulator' },\n          cwd: appReleasePath,\n          shell: true,\n        }\n      );\n    } else if (type === 'archive') {\n      await spawnAsync('/bin/mv', [`${DEFAULT_EXPOKIT_WORKSPACE_NAME}.xcarchive`, output], {\n        pipeToLogger: true,\n        cwd: `${context.data.archivePath}/../../../..`,\n        loggerFields: { buildPhase: 'renaming archive' },\n      });\n    }\n  }\n}\n\n/**\n * possible args:\n *  @param skipRepoUpdate if true, omit `--repo-update` cocoapods flag.\n */\nasync function _createTurtleWorkspaceAsync(context, args) {\n  const { skipRepoUpdate } = args;\n  if (fs.existsSync(context.build.ios.workspaceSourcePath)) {\n    logger.info(`Removing existing workspace at ${context.build.ios.workspaceSourcePath}...`);\n    try {\n      rimraf.sync(context.build.ios.workspaceSourcePath);\n    } catch (_) {}\n  }\n  await IosWorkspace.createDetachedAsync(context);\n  await _podInstallAsync(context.build.ios.workspaceSourcePath, !skipRepoUpdate);\n}\n\n/**\n * External-facing version can be used to create a turtle workspace without building it.\n * Probably only useful for local testing.\n *\n * @param workspacePath (optional) provide some other path to create the workspace besides the default\n * @param url (optional, with sdkVersion) url to an expo manifest, if you want the workspace to be configured automatically\n * @param sdkVersion (optional, with url) sdkVersion to an expo manifest, if you want the workspace to be configured automatically\n */\nasync function createTurtleWorkspaceAsync(args) {\n  args = _validateCLIArgs(args);\n  if (!args.workspacePath) {\n    logger.info(\n      'No workspace path was provided with --workspacePath, so the default will be used.'\n    );\n  }\n  const context = await _createStandaloneContextAsync(args);\n  await _createTurtleWorkspaceAsync(context, args);\n  logger.info(\n    `Created turtle workspace at ${context.build.ios\n      .workspaceSourcePath}. You can open and run this in Xcode.`\n  );\n  if (context.config) {\n    await IosNSBundle.configureAsync(context);\n    logger.info(\n      `The turtle workspace was configured for the url ${args.url}. To run this app with a Debug scheme, make sure to add a development url to 'EXBuildConstants.plist'.`\n    );\n  } else {\n    logger.info(\n      `You can specify --url <manifestUrl> --sdkVersion <version> to configure this workspace as a particular Expo app.\\n\\nBecause those arguments were omitted, the workspace has not been configured. It will compile but not run. The minimum configuration to get something running is to specify a manifest url in 'EXShell.plist' (for Release builds) or 'EXBuildConstants.plist' (for Debug builds).`\n    );\n  }\n}\n\n/**\n * possible args:\n *  @param configuration StandaloneBuildConfiguration (Debug or Release)\n *  @param verbose show all xcodebuild output (default false)\n *  @param reuseWorkspace if true, when building, assume a detached workspace already exists rather than creating a new one.\n *  @param type type of artifact to build (simulator or archive)\n */\nasync function buildAndCopyArtifactAsync(args) {\n  args = _validateCLIArgs(args);\n  const context = await _createStandaloneContextAsync(args);\n  const { verbose, type, reuseWorkspace } = args;\n  const { projectName } = IosWorkspace.getPaths(context);\n\n  if (!reuseWorkspace) {\n    await _createTurtleWorkspaceAsync(context, args);\n  }\n  const pathToArtifact = await _buildAsync(\n    projectName,\n    context.build.ios.workspaceSourcePath,\n    context.build.configuration,\n    type,\n    path.relative(context.build.ios.workspaceSourcePath, '../shellAppBase'),\n    verbose\n  );\n  const artifactDestPath = path.join('../shellAppBase-builds', type, context.build.configuration);\n  logger.info(`\\nFinished building, copying artifact to ${path.resolve(artifactDestPath)}...`);\n  if (fs.existsSync(artifactDestPath)) {\n    await spawnAsyncThrowError('/bin/rm', ['-rf', artifactDestPath]);\n  }\n  logger.info(`mkdir -p ${artifactDestPath}`);\n  await spawnAsyncThrowError('/bin/mkdir', ['-p', artifactDestPath]);\n  logger.info(`cp -R ${pathToArtifact} ${artifactDestPath}`);\n  await spawnAsyncThrowError('/bin/cp', ['-R', pathToArtifact, artifactDestPath]);\n}\n\nexport { buildAndCopyArtifactAsync, configureAndCopyArchiveAsync, createTurtleWorkspaceAsync };\n"],"sourceRoot":"/xdl@50.4.2/src"}