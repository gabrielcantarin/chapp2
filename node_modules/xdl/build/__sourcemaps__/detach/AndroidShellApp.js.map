{"version":3,"sources":["detach/AndroidShellApp.js"],"names":["async","androidSrcPath","shellPath","isDetached","_exponentDirectory","exponentDirectory","await","spawnAsync","pipeToLogger","loggerFields","buildPhase","cwd","path","join","env","process","JSON_LOGS","initialCopyLogger","logger","withFields","copyToShellApp","fileName","fs","copy","e","warn","copyInitialShellAppFilesAsync","resDirPath","folderPrefix","folderSuffix","iconUrl","isLocalUrl","Promise","all","imageKeys","map","key","dirPath","accessSync","constants","F_OK","copyFileSync","saveUrlToPathAsync","copyIconsToResSubfoldersAsync","oldText","newText","regexFileAsync","regexFileInResSubfoldersAsync","context","fnLogger","let","shellPathForContext","url","published","manifest","config","releaseChannel","data","privateConfig","fullManifestUrl","replace","versionCode","javaPackage","android","package","Error","name","scheme","detach","bundleUrl","isFullManifest","notificationIconUrl","notification","version","backgroundImages","backgroundImagesForApp","splashBackgroundColor","getSplashScreenBackgroundColor","updatesDisabled","updates","enabled","icon","iconBackgroundUrl","iconBackgroundColor","iconForegroundUrl","adaptiveIcon","backgroundColor","foregroundImage","backgroundImage","foregroundImageUrl","backgroundImageUrl","remove","appBuildGradle","writeFile","buildGradleFile","readFileSync","androidVersion","match","deleteLinesInFileAsync","shouldShowLoadingView","xmlWeirdAndroidEscape","searchLine","permissions","content","p","whitelist","forEach","s","includes","push","identifier","split","pop","blacklist","filter","writeFileSync","JSON","stringify","globby","absolute","filePath","removeSync","dot","rmdirSync","length","_","image","AssetBundle","bundleAsync","bundledAssets","certificateHash","googleAndroidApiKey","branch","fabric","googleMaps","googleSignIn","apiKey","buildSecret","googleServicesFile","runShellAppModificationsAsync","build","androidBuildConfiguration","gradleArgs","GRADLE_DAEMON_DISABLED","unshift","spawnAsyncThrowError","keystorePassword","keyPassword","keystore","keyAlias","outputFile","buildShellAppAsync","addDetachedConfigToExp","getManifestAsync","TURTLE_WORKING_DIR_PATH","EXPO_UNIVERSE_DIR","original","noAmps","replaceString","noLt","noGt","noApos","exports","updateAndroidShellAppAsync","args","sdkVersion","getRemoteOrLocalUrl","get","basePath","splash","reduce","acc","imageKey","resizeMode","createAndroidShellAppAsync","privateConfigFile","configuration","alias","ensureDir","privateConfigContents","readFile","parse","buildFlags","StandaloneBuildFlags","createAndroid","StandaloneContext","createServiceContext","skipBuild","type","projectPath","exp","console","assetsDirectory","publishBundlePath","relative","publishManifestPath"],"mappings":"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","file":"../../detach/AndroidShellApp.js","sourcesContent":["// Copyright 2015-present 650 Industries. All rights reserved.\n/**\n * @flow\n */\n\n'use strict';\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport replaceString from 'replace-string';\nimport _ from 'lodash';\nimport globby from 'globby';\n\nimport * as AssetBundle from './AssetBundle';\nimport * as ExponentTools from './ExponentTools';\nimport StandaloneBuildFlags from './StandaloneBuildFlags';\nimport StandaloneContext from './StandaloneContext';\nimport logger from './Logger';\n\nconst {\n  getManifestAsync,\n  saveUrlToPathAsync,\n  spawnAsyncThrowError,\n  spawnAsync,\n  regexFileAsync,\n  deleteLinesInFileAsync,\n} = ExponentTools;\n\nconst imageKeys = ['mdpi', 'hdpi', 'xhdpi', 'xxhdpi', 'xxxhdpi'];\n\n// Do not call this from anything used by detach\nfunction exponentDirectory() {\n  if (process.env.TURTLE_WORKING_DIR_PATH) {\n    return process.env.TURTLE_WORKING_DIR_PATH;\n  } else if (process.env.EXPO_UNIVERSE_DIR) {\n    return path.join(process.env.EXPO_UNIVERSE_DIR, 'exponent');\n  } else {\n    return null;\n  }\n}\n\nfunction xmlWeirdAndroidEscape(original) {\n  let noAmps = replaceString(original, '&', '&amp;');\n  let noLt = replaceString(noAmps, '<', '&lt;');\n  let noGt = replaceString(noLt, '>', '&gt;');\n  let noApos = replaceString(noGt, '\"', '\\\\\"');\n  return replaceString(noApos, \"'\", \"\\\\'\");\n}\n\nexports.updateAndroidShellAppAsync = async function updateAndroidShellAppAsync(args: any) {\n  let { url, sdkVersion, releaseChannel } = args;\n\n  releaseChannel = releaseChannel ? releaseChannel : 'default';\n  let manifest = await getManifestAsync(url, {\n    'Exponent-SDK-Version': sdkVersion,\n    'Exponent-Platform': 'android',\n    'Expo-Release-Channel': releaseChannel,\n  });\n\n  let fullManifestUrl = `${url.replace('exp://', 'https://')}/index.exp`;\n  let bundleUrl = manifest.bundleUrl;\n\n  let shellPath = path.join(exponentDirectory(), 'android-shell-app');\n\n  await fs.remove(path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app-manifest.json'));\n  await fs.writeFileSync(\n    path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app-manifest.json'),\n    JSON.stringify(manifest)\n  );\n  await fs.remove(path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app.bundle'));\n  await saveUrlToPathAsync(\n    bundleUrl,\n    path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app.bundle')\n  );\n\n  await deleteLinesInFileAsync(\n    `START\\ EMBEDDED\\ RESPONSES`,\n    `END\\ EMBEDDED\\ RESPONSES`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n\n  await regexFileAsync(\n    '// ADD EMBEDDED RESPONSES HERE',\n    `\n    // ADD EMBEDDED RESPONSES HERE\n    // START EMBEDDED RESPONSES\n    embeddedResponses.add(new Constants.EmbeddedResponse(\"${fullManifestUrl}\", \"assets://shell-app-manifest.json\", \"application/json\"));\n    embeddedResponses.add(new Constants.EmbeddedResponse(\"${bundleUrl}\", \"assets://shell-app.bundle\", \"application/javascript\"));\n    // END EMBEDDED RESPONSES`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n\n  await regexFileAsync(\n    'RELEASE_CHANNEL = \"default\"',\n    `RELEASE_CHANNEL = \"${releaseChannel}\"`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n};\n\nfunction getRemoteOrLocalUrl(manifest, key, isDetached) {\n  // in detached apps, `manifest` is actually just app.json, so there are no remote url fields\n  // we should return a local url starting with file:// instead\n  if (isDetached) {\n    return _.get(manifest, key);\n  }\n  return _.get(manifest, `${key}Url`);\n}\n\nfunction backgroundImagesForApp(shellPath, manifest, isDetached) {\n  // returns an array like:\n  // [\n  //   {url: 'urlToDownload', path: 'pathToSaveTo'},\n  //   {url: 'anotherURlToDownload', path: 'anotherPathToSaveTo'},\n  // ]\n  let basePath = path.join(shellPath, 'app', 'src', 'main', 'res');\n  if (_.get(manifest, 'android.splash')) {\n    var splash = _.get(manifest, 'android.splash');\n    return _.reduce(\n      imageKeys,\n      function(acc, imageKey) {\n        let url = getRemoteOrLocalUrl(splash, imageKey, isDetached);\n        if (url) {\n          acc.push({\n            url,\n            path: path.join(basePath, `drawable-${imageKey}`, 'shell_launch_background_image.png'),\n          });\n        }\n\n        return acc;\n      },\n      []\n    );\n  }\n\n  let url = getRemoteOrLocalUrl(manifest, 'splash.image', isDetached);\n  if (url) {\n    return [\n      {\n        url,\n        path: path.join(basePath, 'drawable-xxxhdpi', 'shell_launch_background_image.png'),\n      },\n    ];\n  }\n\n  return [];\n}\n\nfunction getSplashScreenBackgroundColor(manifest) {\n  let backgroundColor;\n  if (manifest.android && manifest.android.splash && manifest.android.splash.backgroundColor) {\n    backgroundColor = manifest.android.splash.backgroundColor;\n  } else if (manifest.splash && manifest.splash.backgroundColor) {\n    backgroundColor = manifest.splash.backgroundColor;\n  }\n\n  // Default to white\n  if (!backgroundColor) {\n    backgroundColor = '#FFFFFF';\n  }\n  return backgroundColor;\n}\n\n/*\n  if resizeMode is 'cover' we should show LoadingView:\n  using an ImageView, unlike having a BitmapDrawable\n  provides a fullscreen image without distortions\n*/\nfunction shouldShowLoadingView(manifest) {\n  return (\n    (manifest.android &&\n      manifest.android.splash &&\n      manifest.android.splash.resizeMode &&\n      manifest.android.splash.resizeMode === 'cover') ||\n    (manifest.splash && manifest.splash.resizeMode && manifest.splash.resizeMode === 'cover')\n  );\n}\n\nexport async function copyInitialShellAppFilesAsync(\n  androidSrcPath,\n  shellPath,\n  isDetached: boolean = false\n) {\n  const _exponentDirectory = exponentDirectory();\n  if (_exponentDirectory) {\n    await spawnAsync(`../../tools-public/generate-dynamic-macros-android.sh`, [], {\n      pipeToLogger: true,\n      loggerFields: { buildPhase: 'generating dynamic macros' },\n      cwd: path.join(_exponentDirectory, 'android', 'app'),\n      env: {\n        ...process.env,\n        JSON_LOGS: '0',\n      },\n    }); // populate android template files now since we take out the prebuild step later on\n  }\n\n  const initialCopyLogger = logger.withFields({ buildPhase: 'copying initial shell app files' });\n\n  const copyToShellApp = async fileName => {\n    try {\n      await fs.copy(path.join(androidSrcPath, fileName), path.join(shellPath, fileName));\n    } catch (e) {\n      // android.iml is only available locally, not on the builders, so don't crash when this happens\n      initialCopyLogger.warn(`Warning: Could not copy ${fileName} to shell app directory.`);\n    }\n  };\n\n  if (!isDetached) {\n    await copyToShellApp('expoview');\n    await copyToShellApp('ReactCommon');\n    await copyToShellApp('ReactAndroid');\n  }\n\n  await copyToShellApp('android.iml');\n  await copyToShellApp('app');\n  await copyToShellApp('build.gradle');\n  await copyToShellApp('gradle');\n  await copyToShellApp('gradle.properties');\n  await copyToShellApp('gradlew');\n  await copyToShellApp('settings.gradle');\n  await copyToShellApp('maven');\n  await copyToShellApp('debug.keystore');\n  await copyToShellApp('run.sh');\n  await copyToShellApp('detach-scripts');\n}\n\nexports.createAndroidShellAppAsync = async function createAndroidShellAppAsync(args: any) {\n  let {\n    url,\n    sdkVersion,\n    releaseChannel,\n    privateConfigFile,\n    configuration,\n    keystore,\n    alias,\n    keystorePassword,\n    keyPassword,\n    outputFile,\n  } = args;\n\n  let androidSrcPath = path.join(exponentDirectory(), 'android');\n  let shellPath = path.join(exponentDirectory(), 'android-shell-app');\n\n  await fs.remove(shellPath);\n  await fs.ensureDir(shellPath);\n\n  releaseChannel = releaseChannel ? releaseChannel : 'default';\n  let manifest = await getManifestAsync(url, {\n    'Exponent-SDK-Version': sdkVersion,\n    'Exponent-Platform': 'android',\n    'Expo-Release-Channel': releaseChannel,\n  });\n  configuration = configuration ? configuration : 'Release';\n\n  let privateConfig;\n  if (privateConfigFile) {\n    let privateConfigContents = await fs.readFile(privateConfigFile, 'utf8');\n    privateConfig = JSON.parse(privateConfigContents);\n  } else if (manifest.android) {\n    privateConfig = manifest.android.config;\n  }\n\n  let androidBuildConfiguration;\n  if (keystore && alias && keystorePassword && keyPassword) {\n    androidBuildConfiguration = {\n      keystore,\n      keystorePassword,\n      keyAlias: alias,\n      keyPassword,\n      outputFile,\n    };\n  }\n\n  let buildFlags = StandaloneBuildFlags.createAndroid(configuration, androidBuildConfiguration);\n  let context = StandaloneContext.createServiceContext(\n    androidSrcPath,\n    null,\n    manifest,\n    privateConfig,\n    /* testEnvironment */ 'none',\n    buildFlags,\n    url,\n    releaseChannel\n  );\n\n  await copyInitialShellAppFilesAsync(androidSrcPath, shellPath);\n  await runShellAppModificationsAsync(context);\n\n  if (!args.skipBuild) {\n    await buildShellAppAsync(context);\n  }\n};\n\nfunction shellPathForContext(context: StandaloneContext) {\n  if (context.type === 'user') {\n    return path.join(context.data.projectPath, 'android');\n  } else {\n    return path.join(exponentDirectory(), 'android-shell-app');\n  }\n}\n\nasync function copyIconsToResSubfoldersAsync(\n  resDirPath,\n  folderPrefix,\n  folderSuffix,\n  fileName,\n  iconUrl,\n  isLocalUrl\n) {\n  return Promise.all(\n    imageKeys.map(async key => {\n      try {\n        const dirPath = path.join(resDirPath, `${folderPrefix}${key}${folderSuffix}`);\n        fs.accessSync(dirPath, fs.constants.F_OK);\n        if (isLocalUrl) {\n          return fs.copyFileSync(iconUrl, path.join(dirPath, fileName));\n        }\n        return saveUrlToPathAsync(iconUrl, path.join(dirPath, fileName));\n      } catch (e) {\n        // directory does not exist, so ignore\n      }\n    })\n  );\n}\n\nasync function regexFileInResSubfoldersAsync(\n  oldText,\n  newText,\n  resDirPath,\n  folderPrefix,\n  folderSuffix,\n  fileName\n) {\n  return Promise.all(\n    imageKeys.map(async key => {\n      return regexFileAsync(\n        oldText,\n        newText,\n        path.join(resDirPath, `${folderPrefix}${key}${folderSuffix}`, fileName)\n      );\n    })\n  );\n}\n\nexport async function runShellAppModificationsAsync(\n  context: StandaloneContext,\n  isDetached: boolean = false\n) {\n  const fnLogger = logger.withFields({ buildPhase: 'running shell app modifications' });\n\n  let shellPath = shellPathForContext(context);\n  let url: string = context.published.url;\n  let manifest = context.config; // manifest or app.json\n  let releaseChannel = context.published.releaseChannel;\n\n  if (!context.data.privateConfig) {\n    fnLogger.warn('Warning: No config file specified.');\n  }\n\n  let fullManifestUrl = `${url.replace('exp://', 'https://')}/index.exp`;\n\n  let versionCode = 1;\n  let javaPackage = manifest.android.package;\n  if (manifest.android.versionCode) {\n    versionCode = manifest.android.versionCode;\n  }\n\n  if (!javaPackage) {\n    throw new Error(\n      'Must specify androidPackage option (either from manifest or on command line).'\n    );\n  }\n\n  let name = manifest.name;\n  let iconUrl =\n    manifest.android && manifest.android.iconUrl ? manifest.android.iconUrl : manifest.iconUrl;\n  let scheme = manifest.scheme || (manifest.detach && manifest.detach.scheme);\n  let bundleUrl: ?string = manifest.bundleUrl;\n  let isFullManifest = !!bundleUrl;\n  let notificationIconUrl = manifest.notification ? manifest.notification.iconUrl : null;\n  let version = manifest.version ? manifest.version : '0.0.0';\n  let backgroundImages = backgroundImagesForApp(shellPath, manifest, isDetached);\n  let splashBackgroundColor = getSplashScreenBackgroundColor(manifest);\n  let updatesDisabled = manifest.updates && manifest.updates.enabled === false;\n\n  if (isDetached) {\n    // manifest is actually just app.json in this case, so iconUrl fields don't exist\n    iconUrl = manifest.android && manifest.android.icon ? manifest.android.icon : manifest.icon;\n    notificationIconUrl = manifest.notification ? manifest.notification.icon : null;\n  }\n\n  let iconBackgroundUrl;\n  let iconBackgroundColor;\n  let iconForegroundUrl;\n  if (manifest.android && manifest.android.adaptiveIcon) {\n    iconBackgroundColor = manifest.android.adaptiveIcon.backgroundColor;\n    if (isDetached) {\n      iconForegroundUrl = manifest.android.adaptiveIcon.foregroundImage;\n      iconBackgroundUrl = manifest.android.adaptiveIcon.backgroundImage;\n    } else {\n      iconForegroundUrl = manifest.android.adaptiveIcon.foregroundImageUrl;\n      iconBackgroundUrl = manifest.android.adaptiveIcon.backgroundImageUrl;\n    }\n  }\n\n  // Clean build directories\n  await fs.remove(path.join(shellPath, 'app', 'build'));\n  await fs.remove(path.join(shellPath, 'ReactAndroid', 'build'));\n  await fs.remove(path.join(shellPath, 'expoview', 'build'));\n  await fs.remove(path.join(shellPath, 'app', 'src', 'androidTest'));\n\n  if (isDetached) {\n    let appBuildGradle = path.join(shellPath, 'app', 'build.gradle');\n    await regexFileAsync(/\\/\\* UNCOMMENT WHEN DISTRIBUTING/g, '', appBuildGradle);\n    await regexFileAsync(/END UNCOMMENT WHEN DISTRIBUTING \\*\\//g, '', appBuildGradle);\n    await regexFileAsync(`compile project(path: ':expoview')`, '', appBuildGradle);\n\n    // Don't need to compile expoview or ReactAndroid\n    // react-native link looks for a \\n so we need that. See https://github.com/facebook/react-native/blob/master/local-cli/link/android/patches/makeSettingsPatch.js\n    await fs.writeFile(path.join(shellPath, 'settings.gradle'), `include ':app'\\n`);\n\n    await regexFileAsync(\n      'TEMPLATE_INITIAL_URL',\n      url,\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'MainActivity.java'\n      )\n    );\n  }\n\n  // Package\n  await regexFileAsync(\n    `applicationId 'host.exp.exponent'`,\n    `applicationId '${javaPackage}'`,\n    path.join(shellPath, 'app', 'build.gradle')\n  );\n  await regexFileAsync(\n    `android:name=\"host.exp.exponent\"`,\n    `android:name=\"${javaPackage}\"`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  // Versions\n  let buildGradleFile = await fs.readFileSync(path.join(shellPath, 'app', 'build.gradle'), 'utf8');\n  let androidVersion = buildGradleFile.match(/versionName '(\\S+)'/)[1];\n  await regexFileAsync(\n    'VERSION_NAME = null',\n    `VERSION_NAME = \"${androidVersion}\"`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n  await deleteLinesInFileAsync(\n    `BEGIN\\ VERSIONS`,\n    `END\\ VERSIONS`,\n    path.join(shellPath, 'app', 'build.gradle')\n  );\n  await regexFileAsync(\n    '// ADD VERSIONS HERE',\n    `versionCode ${versionCode}\n    versionName '${version}'`,\n    path.join(shellPath, 'app', 'build.gradle')\n  );\n\n  // Remove Exponent build script\n  if (!isDetached) {\n    await regexFileAsync(\n      `preBuild.dependsOn generateDynamicMacros`,\n      ``,\n      path.join(shellPath, 'expoview', 'build.gradle')\n    );\n  }\n\n  // change javaMaxHeapSize\n  await regexFileAsync(\n    `javaMaxHeapSize \"8g\"`,\n    `javaMaxHeapSize \"6g\"`,\n    path.join(shellPath, 'app', 'build.gradle')\n  );\n\n  // Push notifications\n  await regexFileAsync(\n    '\"package_name\": \"host.exp.exponent\"',\n    `\"package_name\": \"${javaPackage}\"`,\n    path.join(shellPath, 'app', 'google-services.json')\n  ); // TODO: actually use the correct file\n\n  // TODO: probably don't need this in both places\n  await regexFileAsync(\n    /host\\.exp\\.exponent\\.permission\\.C2D_MESSAGE/g,\n    `${javaPackage}.permission.C2D_MESSAGE`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n  if (!isDetached) {\n    await regexFileAsync(\n      /host\\.exp\\.exponent\\.permission\\.C2D_MESSAGE/g,\n      `${javaPackage}.permission.C2D_MESSAGE`,\n      path.join(shellPath, 'expoview', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n\n  // Set INITIAL_URL, SHELL_APP_SCHEME and SHOW_LOADING_VIEW\n  await regexFileAsync(\n    'INITIAL_URL = null',\n    `INITIAL_URL = \"${url}\"`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n  if (scheme) {\n    await regexFileAsync(\n      'SHELL_APP_SCHEME = null',\n      `SHELL_APP_SCHEME = \"${scheme}\"`,\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n  if (shouldShowLoadingView(manifest)) {\n    await regexFileAsync(\n      'SHOW_LOADING_VIEW_IN_SHELL_APP = false',\n      'SHOW_LOADING_VIEW_IN_SHELL_APP = true',\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n  if (isDetached) {\n    await regexFileAsync(\n      'IS_DETACHED = false',\n      `IS_DETACHED = true`,\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n  if (updatesDisabled) {\n    await regexFileAsync(\n      'ARE_REMOTE_UPDATES_ENABLED = true',\n      'ARE_REMOTE_UPDATES_ENABLED = false',\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n\n  // App name\n  await regexFileAsync(\n    '\"app_name\">Expo',\n    `\"app_name\">${xmlWeirdAndroidEscape(name)}`,\n    path.join(shellPath, 'app', 'src', 'main', 'res', 'values', 'strings.xml')\n  );\n\n  // Splash Screen background color\n  await regexFileAsync(\n    '\"splashBackground\">#FFFFFF',\n    `\"splashBackground\">${splashBackgroundColor}`,\n    path.join(shellPath, 'app', 'src', 'main', 'res', 'values', 'colors.xml')\n  );\n\n  // show only background color if LoadingView will appear\n  if (shouldShowLoadingView(manifest)) {\n    await regexFileAsync(\n      /<item>.*<\\/item>/,\n      '',\n      path.join(shellPath, 'app', 'src', 'main', 'res', 'drawable', 'splash_background.xml')\n    );\n  }\n\n  // Remove exp:// scheme from LauncherActivity\n  await deleteLinesInFileAsync(\n    `START\\ LAUNCHER\\ INTENT\\ FILTERS`,\n    `END\\ LAUNCHER\\ INTENT\\ FILTERS`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  // Remove LAUNCHER category from HomeActivity\n  await deleteLinesInFileAsync(\n    `START\\ HOME\\ INTENT\\ FILTERS`,\n    `END\\ HOME\\ INTENT\\ FILTERS`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  if (isDetached) {\n    // Add LAUNCHER category to MainActivity\n    await regexFileAsync(\n      '<!-- ADD DETACH INTENT FILTERS HERE -->',\n      `<intent-filter>\n        <action android:name=\"android.intent.action.MAIN\"/>\n\n        <category android:name=\"android.intent.category.LAUNCHER\"/>\n      </intent-filter>`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  } else {\n    // Add LAUNCHER category to ShellAppActivity\n    await regexFileAsync(\n      '<!-- ADD SHELL INTENT FILTERS HERE -->',\n      `<intent-filter>\n        <action android:name=\"android.intent.action.MAIN\"/>\n\n        <category android:name=\"android.intent.category.LAUNCHER\"/>\n      </intent-filter>`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n\n  // Add shell app scheme\n  if (scheme) {\n    const searchLine = isDetached\n      ? '<!-- ADD DETACH SCHEME HERE -->'\n      : '<!-- ADD SHELL SCHEME HERE -->';\n    await regexFileAsync(\n      searchLine,\n      `<intent-filter>\n        <data android:scheme=\"${scheme}\"/>\n\n        <action android:name=\"android.intent.action.VIEW\"/>\n\n        <category android:name=\"android.intent.category.DEFAULT\"/>\n        <category android:name=\"android.intent.category.BROWSABLE\"/>\n      </intent-filter>`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n\n  // Add permissions\n  if (manifest.android && manifest.android.permissions) {\n    const content = await fs.readFileSync(\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml'),\n      'utf-8'\n    );\n\n    // Get the list of optional permissions form manifest\n    const permissions = content\n      .replace(\n        /(([\\s\\S]*<!-- BEGIN OPTIONAL PERMISSIONS -->)|(<!-- END OPTIONAL PERMISSIONS -->[\\s\\S]*))/g,\n        ''\n      )\n      .match(/android:name=\".+\"/g)\n      .map(p => p.replace(/(android:name=|\")/g, ''));\n\n    const whitelist = [];\n\n    manifest.android.permissions.forEach(s => {\n      if (s.includes('.')) {\n        whitelist.push(s);\n      } else {\n        permissions.forEach(identifier => {\n          if (identifier.split('.').pop() === s) {\n            whitelist.push(identifier);\n          }\n        });\n      }\n    });\n\n    // Permissions we need to remove from the generated manifest\n    const blacklist = [\n      'android.permission.ACCESS_COARSE_LOCATION',\n      'android.permission.ACCESS_FINE_LOCATION',\n      'android.permission.CAMERA',\n      'android.permission.MANAGE_DOCUMENTS',\n      'android.permission.READ_CONTACTS',\n      'android.permission.READ_CALENDAR',\n      'android.permission.WRITE_CALENDAR',\n      'android.permission.READ_EXTERNAL_STORAGE',\n      'android.permission.READ_INTERNAL_STORAGE',\n      'android.permission.READ_PHONE_STATE',\n      'android.permission.RECORD_AUDIO',\n      'android.permission.USE_FINGERPRINT',\n      'android.permission.VIBRATE',\n      'android.permission.WRITE_EXTERNAL_STORAGE',\n      'com.anddoes.launcher.permission.UPDATE_COUNT',\n      'com.android.launcher.permission.INSTALL_SHORTCUT',\n      'com.google.android.gms.permission.ACTIVITY_RECOGNITION',\n      'com.google.android.providers.gsf.permission.READ_GSERVICES',\n      'com.htc.launcher.permission.READ_SETTINGS',\n      'com.htc.launcher.permission.UPDATE_SHORTCUT',\n      'com.majeur.launcher.permission.UPDATE_BADGE',\n      'com.sec.android.provider.badge.permission.READ',\n      'com.sec.android.provider.badge.permission.WRITE',\n      'com.sonyericsson.home.permission.BROADCAST_BADGE',\n    ].filter(p => !whitelist.includes(p));\n\n    await deleteLinesInFileAsync(\n      `BEGIN\\ OPTIONAL\\ PERMISSIONS`,\n      `END\\ OPTIONAL\\ PERMISSIONS`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n\n    await regexFileAsync(\n      '<!-- ADD PERMISSIONS HERE -->',\n      `\n      ${whitelist.map(p => `<uses-permission android:name=\"${p}\" />`).join('\\n')}\n      ${blacklist\n        .map(p => `<uses-permission android:name=\"${p}\" tools:node=\"remove\" />`)\n        .join('\\n')}\n      `,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n  }\n\n  // OAuth redirect scheme\n  await regexFileAsync(\n    '<data android:scheme=\"host.exp.exponent\" android:path=\"oauthredirect\"/>',\n    `<data android:scheme=\"${javaPackage}\" android:path=\"oauthredirect\"/>`,\n    path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n  );\n\n  // Embed manifest and bundle\n  if (isFullManifest) {\n    await fs.writeFileSync(\n      path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app-manifest.json'),\n      JSON.stringify(manifest)\n    );\n    await saveUrlToPathAsync(\n      bundleUrl,\n      path.join(shellPath, 'app', 'src', 'main', 'assets', 'shell-app.bundle')\n    );\n\n    await regexFileAsync(\n      '// START EMBEDDED RESPONSES',\n      `\n      // START EMBEDDED RESPONSES\n      embeddedResponses.add(new Constants.EmbeddedResponse(\"${fullManifestUrl}\", \"assets://shell-app-manifest.json\", \"application/json\"));\n      embeddedResponses.add(new Constants.EmbeddedResponse(\"${bundleUrl}\", \"assets://shell-app.bundle\", \"application/javascript\"));`,\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n\n  await regexFileAsync(\n    'RELEASE_CHANNEL = \"default\"',\n    `RELEASE_CHANNEL = \"${releaseChannel}\"`,\n    path.join(\n      shellPath,\n      'app',\n      'src',\n      'main',\n      'java',\n      'host',\n      'exp',\n      'exponent',\n      'generated',\n      'AppConstants.java'\n    )\n  );\n\n  // Icon\n  if (iconUrl || iconForegroundUrl) {\n    if (iconUrl) {\n      (await globby(['**/ic_launcher.png'], {\n        cwd: path.join(shellPath, 'app', 'src', 'main', 'res'),\n        absolute: true,\n      })).forEach(filePath => {\n        fs.removeSync(filePath);\n      });\n\n      await copyIconsToResSubfoldersAsync(\n        path.join(shellPath, 'app', 'src', 'main', 'res'),\n        'mipmap-',\n        '',\n        'ic_launcher.png',\n        iconUrl,\n        isDetached\n      );\n    }\n\n    if (iconForegroundUrl) {\n      (await globby(['**/ic_foreground.png'], {\n        cwd: path.join(shellPath, 'app', 'src', 'main', 'res'),\n        absolute: true,\n      })).forEach(filePath => {\n        fs.removeSync(filePath);\n      });\n\n      await copyIconsToResSubfoldersAsync(\n        path.join(shellPath, 'app', 'src', 'main', 'res'),\n        'mipmap-',\n        '-v26',\n        'ic_foreground.png',\n        iconForegroundUrl,\n        isDetached\n      );\n    } else {\n      // the OS's default method of coercing normal app icons to adaptive\n      // makes them look quite different from using an actual adaptive icon (with xml)\n      // so we need to support falling back to the old version on Android 8\n      (await globby(['**/mipmap-*-v26/*'], {\n        cwd: path.join(shellPath, 'app', 'src', 'main', 'res'),\n        absolute: true,\n        dot: true,\n      })).forEach(filePath => {\n        fs.removeSync(filePath);\n      });\n\n      try {\n        (await globby(['**/mipmap-*-v26'], {\n          cwd: path.join(shellPath, 'app', 'src', 'main', 'res'),\n          absolute: true,\n        })).forEach(filePath => {\n          fs.rmdirSync(filePath);\n        });\n      } catch (e) {\n        // we don't want the entire detach script to fail if node\n        // can't remove the directories for whatever reason.\n        // people can remove the directories themselves if they need\n        // so just fail silently here\n      }\n    }\n  }\n\n  if (iconBackgroundUrl) {\n    await copyIconsToResSubfoldersAsync(\n      path.join(shellPath, 'app', 'src', 'main', 'res'),\n      'mipmap-',\n      '-v26',\n      'ic_background.png',\n      iconBackgroundUrl,\n      isDetached\n    );\n\n    await regexFileInResSubfoldersAsync(\n      '@color/iconBackground',\n      '@mipmap/ic_background',\n      path.join(shellPath, 'app', 'src', 'main', 'res'),\n      'mipmap-',\n      '-v26',\n      'ic_launcher.xml'\n    );\n  } else if (iconBackgroundColor) {\n    await regexFileAsync(\n      '\"iconBackground\">#FFFFFF',\n      `\"iconBackground\">${iconBackgroundColor}`,\n      path.join(shellPath, 'app', 'src', 'main', 'res', 'values', 'colors.xml')\n    );\n  }\n\n  if (notificationIconUrl) {\n    (await globby(['**/shell_notification_icon.png'], {\n      cwd: path.join(shellPath, 'app', 'src', 'main', 'res'),\n      absolute: true,\n    })).forEach(filePath => {\n      fs.removeSync(filePath);\n    });\n\n    await copyIconsToResSubfoldersAsync(\n      path.join(shellPath, 'app', 'src', 'main', 'res'),\n      'drawable-',\n      '',\n      'shell_notification_icon.png',\n      notificationIconUrl,\n      isDetached\n    );\n  }\n\n  // Splash Background\n  if (backgroundImages && backgroundImages.length > 0) {\n    // Delete the placeholder images\n    (await globby(['**/shell_launch_background_image.png'], {\n      cwd: path.join(shellPath, 'app', 'src', 'main', 'res'),\n      absolute: true,\n    })).forEach(filePath => {\n      fs.removeSync(filePath);\n    });\n\n    _.forEach(backgroundImages, async image => {\n      if (isDetached) {\n        // local file so just copy it\n        fs.copyFileSync(image.url, image.path);\n      } else {\n        await saveUrlToPathAsync(image.url, image.path);\n      }\n    });\n  }\n\n  await AssetBundle.bundleAsync(manifest.bundledAssets, `${shellPath}/app/src/main/assets`);\n\n  let certificateHash = '';\n  let googleAndroidApiKey = '';\n  let privateConfig = context.data.privateConfig;\n  if (privateConfig) {\n    let branch = privateConfig.branch;\n    let fabric = privateConfig.fabric;\n    let googleMaps = privateConfig.googleMaps;\n    let googleSignIn = privateConfig.googleSignIn;\n\n    // Branch\n    if (branch) {\n      await regexFileAsync(\n        '<!-- ADD BRANCH CONFIG HERE -->',\n        `<meta-data\n      android:name=\"io.branch.sdk.BranchKey\"\n      android:value=\"${branch.apiKey}\"/>`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    }\n\n    // Fabric\n    if (fabric) {\n      await fs.remove(path.join(shellPath, 'app', 'fabric.properties'));\n      await fs.writeFileSync(\n        path.join(shellPath, 'app', 'fabric.properties'),\n        `apiSecret=${fabric.buildSecret}\\n`\n      );\n\n      await deleteLinesInFileAsync(\n        `BEGIN\\ FABRIC\\ CONFIG`,\n        `END\\ FABRIC\\ CONFIG`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n      await regexFileAsync(\n        '<!-- ADD FABRIC CONFIG HERE -->',\n        `<meta-data\n      android:name=\"io.fabric.ApiKey\"\n      android:value=\"${fabric.apiKey}\"/>`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    }\n\n    // Google Maps\n    if (googleMaps) {\n      await deleteLinesInFileAsync(\n        `BEGIN\\ GOOGLE\\ MAPS\\ CONFIG`,\n        `END\\ GOOGLE\\ MAPS\\ CONFIG`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n      await regexFileAsync(\n        '<!-- ADD GOOGLE MAPS CONFIG HERE -->',\n        `<meta-data\n      android:name=\"com.google.android.geo.API_KEY\"\n      android:value=\"${googleMaps.apiKey}\"/>`,\n        path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n      );\n    }\n\n    // Google Login\n    if (googleSignIn) {\n      certificateHash = googleSignIn.certificateHash;\n      googleAndroidApiKey = googleSignIn.apiKey;\n    }\n  }\n\n  if (manifest.android && manifest.android.googleServicesFile) {\n    // google-services.json\n    // Used for configuring FCM\n    await fs.writeFile(\n      path.join(shellPath, 'app', 'google-services.json'),\n      manifest.android.googleServicesFile\n    );\n\n    await regexFileAsync(\n      '<!-- ADD FCM CONFIG HERE -->',\n      `<service\n        android:name=\".fcm.ExpoFcmMessagingService\">\n        <intent-filter>\n            <action android:name=\"com.google.firebase.MESSAGING_EVENT\"/>\n        </intent-filter>\n      </service>\n      <service\n        android:name=\".fcm.ExpoFcmInstanceIDService\">\n        <intent-filter>\n            <action android:name=\"com.google.firebase.INSTANCE_ID_EVENT\"/>\n        </intent-filter>\n      </service>\n      <meta-data\n        android:name=\"com.google.firebase.messaging.default_notification_icon\"\n        android:resource=\"@drawable/shell_notification_icon\" />\n      <meta-data\n        android:name=\"com.google.firebase.messaging.default_notification_color\"\n        android:resource=\"@color/colorAccent\" />\n      <service\n        android:name=\".fcm.FcmRegistrationIntentService\"\n        android:exported=\"false\">\n      </service>`,\n      path.join(shellPath, 'app', 'src', 'main', 'AndroidManifest.xml')\n    );\n\n    await regexFileAsync(\n      'FCM_ENABLED = false',\n      'FCM_ENABLED = true',\n      path.join(\n        shellPath,\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      )\n    );\n  }\n\n  // Google sign in\n  await regexFileAsync(\n    /\"current_key\": \"(.*?)\"/,\n    `\"current_key\": \"${googleAndroidApiKey}\"`,\n    path.join(shellPath, 'app', 'google-services.json')\n  );\n  await regexFileAsync(\n    /\"certificate_hash\": \"(.*?)\"/,\n    `\"certificate_hash\": \"${certificateHash}\"`,\n    path.join(shellPath, 'app', 'google-services.json')\n  );\n}\n\nasync function buildShellAppAsync(context: StandaloneContext) {\n  let shellPath = shellPathForContext(context);\n\n  if (context.build.android) {\n    let androidBuildConfiguration = context.build.android;\n\n    try {\n      await fs.remove(`shell-unaligned.apk`);\n      await fs.remove(`shell.apk`);\n    } catch (e) {}\n    const gradleArgs = [`assembleProdRelease`];\n    if (process.env.GRADLE_DAEMON_DISABLED) {\n      gradleArgs.unshift('--no-daemon');\n    }\n    await spawnAsyncThrowError(`./gradlew`, gradleArgs, {\n      pipeToLogger: true,\n      loggerFields: { buildPhase: 'running gradle' },\n      cwd: shellPath,\n    });\n    await fs.copy(\n      path.join(shellPath, 'app', 'build', 'outputs', 'apk', 'app-prod-release-unsigned.apk'),\n      `shell-unaligned.apk`\n    );\n    await spawnAsync(\n      `jarsigner`,\n      [\n        '-verbose',\n        '-sigalg',\n        'SHA1withRSA',\n        '-digestalg',\n        'SHA1',\n        '-storepass',\n        androidBuildConfiguration.keystorePassword,\n        '-keypass',\n        androidBuildConfiguration.keyPassword,\n        '-keystore',\n        androidBuildConfiguration.keystore,\n        'shell-unaligned.apk',\n        androidBuildConfiguration.keyAlias,\n      ],\n      {\n        pipeToLogger: true,\n        loggerFields: { buildPhase: 'signing created apk' },\n      }\n    );\n    await spawnAsync(`zipalign`, ['-v', '4', 'shell-unaligned.apk', 'shell.apk'], {\n      pipeToLogger: true,\n      loggerFields: { buildPhase: 'verifying apk alignment' },\n    });\n    try {\n      await fs.remove('shell-unaligned.apk');\n    } catch (e) {}\n    await spawnAsync(\n      `jarsigner`,\n      [\n        '-verify',\n        '-verbose',\n        '-certs',\n        '-keystore',\n        androidBuildConfiguration.keystore,\n        'shell.apk',\n      ],\n      {\n        pipeToLogger: true,\n        loggerFields: { buildPhase: 'verifying apk' },\n      }\n    );\n    await fs.copy('shell.apk', androidBuildConfiguration.outputFile || '/tmp/shell-signed.apk');\n  } else {\n    try {\n      await fs.remove('shell-debug.apk');\n    } catch (e) {}\n    await spawnAsyncThrowError(`./gradlew`, ['assembleDevRemoteKernelDebug'], {\n      pipeToLogger: true,\n      loggerFields: { buildPhase: 'running gradle' },\n      cwd: shellPath,\n    });\n    await fs.copy(\n      path.join(shellPath, 'app', 'build', 'outputs', 'apk', 'app-devRemoteKernel-debug.apk'),\n      `/tmp/shell-debug.apk`\n    );\n  }\n}\n\nexport function addDetachedConfigToExp(exp: Object, context: StandaloneContext): Object {\n  if (context.type !== 'user') {\n    console.warn(`Tried to modify exp for a non-user StandaloneContext, ignoring`);\n    return exp;\n  }\n  let shellPath = shellPathForContext(context);\n  let assetsDirectory = path.join(shellPath, 'app', 'src', 'main', 'assets');\n  exp.android.publishBundlePath = path.relative(\n    context.data.projectPath,\n    path.join(assetsDirectory, 'shell-app.bundle')\n  );\n  exp.android.publishManifestPath = path.relative(\n    context.data.projectPath,\n    path.join(assetsDirectory, 'shell-app-manifest.json')\n  );\n  return exp;\n}\n"],"sourceRoot":"/xdl@50.5.0/src"}